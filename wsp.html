<!DOCTYPE html>

<html>
    <head>
        <title>Test WSP Node.js</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script type="text/javascript" src="http://www.wsprice.it:8673/socket.io/socket.io.js"></script>
        <script src="http://www.wsprice.it/bundles/metronicadmin/plugins/jquery-1.10.2.min.js" type="text/javascript"></script>
        <script src="http://www.wsprice.it/bundles/metronicadmin/plugins/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>   
        <script src="http://www.wsprice.it/bundles/ephputility/js/commons/sugar-1.3.9.min.js" type="text/javascript"></script>   
        <!-- 
        <script type="text/javascript" src="http://localhost:8673/socket.io/socket.io.js"></script>
        <script src="http://worldstickerprice.com/bundles/metronicadmin/plugins/jquery-1.10.2.min.js" type="text/javascript"></script>
        <script src="http://worldstickerprice.com/bundles/metronicadmin/plugins/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>   
        <script src="http://worldstickerprice.com/bundles/ephputility/js/commons/sugar-1.3.9.min.js" type="text/javascript"></script>   
        -->

        <script type="text/javascript">
            var socket = io.connect('http://www.wsprice.it:8673');
//            var socket = io.connect('http://localhost:8673');
            var user = Math.round(Math.random() * 9999);

            var $dom = null;

            function emit(id) {
                log(id, 'emit', array2object($('#' + id).serializeArray()));
                socket.emit(id, array2object($('#' + id).serializeArray()));
            }

            function array2object(array) {
                var object = Object.extended();
                $.map(array, function(n, i) {
                    if(n['name'].last() === ']') {
                        var tokens = n['name'].remove(']').replace('[', ' ').words();
                        if(tokens.length === 2) {
                            if(!object[tokens[0]]) {
                                object[tokens[0]] = Object.extended();
                            }
                            object[tokens[0]][tokens[1]] = n['value'];
                        }
                    } else {
                        object[n['name']] = n['value'];
                    }
                });
                return object;
            }

            function log(action, mode, data) {
                $tr = $('<tr></tr>');
                now = new Date();
                $tr.append('<td nowrap>' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ' ' + now.getMilliseconds() + '</td>');
                $tr.append('<td>' + action + '</td>');
                $tr.append('<td>' + mode + '</td>');
                $tr.append('<td>' + JSON.stringify(data) + '</td>');
                $('#log').prepend($tr);
            }

            socket.on('login', function(response) {
                log('login', 'on', response);
            });

            socket.on('getNegozi', function(response) {
                log('getNegozi', 'on', response);
            });

            socket.on('setNomeNegozio', function(response) {
                log('setDescrizioneNegozio', 'on', response);
            });

            socket.on('setDatiNegozio', function(response) {
                log('setDatiNegozio', 'on', response);
            });

            $(document).ready(function() {
                $('#emit').change(function() {
                    $('.emit').hide();
                    $('#tr_' + $(this).val()).show();
                });
            });
        </script>
    </head>
    <body>
        <table>
            <thead>
                <tr>
                    <th>Test</th>
                    <th>LOG</th>
                </tr>
            </thead>
            <tbody>
                <tr valign="top">
                    <td>
                        <select id="emit">
                            <option value="login">Login</option>
                            <optgroup label="Lettura">
                                <option value="getNegozi">Get Negozi</option>
                            </optgroup>
                            <optgroup label="Scrittura">
                                <option value="setDatiNegozio">Set Dati Negozio</option>
                            </optgroup>
                        </select>
                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Form</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="tr_login" class="emit">
                                    <td>
                                        <form class="socket" id="login" onsubmit="return false">
                                            <div>
                                                <label>Username</label><br/>
                                                <input type="text" name="_username">
                                            </div>
                                            <div>
                                                <label>Password</label><br/>
                                                <input type="text" name="_password">
                                            </div>
                                            <button onclick="emit('login')">LOGIN</button>
                                        </form>
                                    </td>
                                </tr>
                                <tr id="tr_getNegozi" class="emit" style="display: none;">
                                    <td>
                                        <form class="socket" id="getNegozi" onsubmit="return false">
                                            <div>
                                                <label>Token</label><br/>
                                                <input type="text" name="token">
                                            </div>
                                            <button onclick="emit('getNegozi')">GET NEGOZI</button>
                                        </form>
                                    </td>
                                </tr>
                                <tr id="tr_setDatiNegozio" class="emit" style="display: none;">
                                    <td>
                                        <form class="socket" id="setDatiNegozio" onsubmit="return false">
                                            <div>
                                                <label>Token</label><br/>
                                                <input type="text" name="token">
                                            </div>
                                            <div>
                                                <label>Negozio</label><br/>
                                                <input type="text" name="id">
                                            </div>
                                            <div>
                                                <label>Nome</label><br/>
                                                <input type="text" name="dati[nome]">
                                            </div>
                                            <div>
                                                <label>Descrizione</label><br/>
                                                <textarea name="dati[descrizione]"></textarea>
                                            </div>
                                            <div>
                                                <label>Email</label><br/>
                                                <input type="text" name="dati[email_negozio]">
                                            </div>
                                            <div>
                                                <label>Telefono</label><br/>
                                                <input type="text" name="dati[telefono]">
                                            </div>
                                            <div>
                                                <label>Cellulare</label><br/>
                                                <input type="text" name="dati[cellulare]">
                                            </div>
                                            <div>
                                                <label>Fax</label><br/>
                                                <input type="text" name="dati[fax]">
                                            </div>
                                            <div>
                                                <label>Sito</label><br/>
                                                <input type="text" name="dati[sito]">
                                            </div>
                                            <div>
                                                <label>Aperture speciali</label><br/>
                                                <textarea name="dati[aperture_speciali]"></textarea>
                                            </div>
                                            <div>
                                                <label>Ambulante</label><br/>
                                                <input type="checkbox" name="dati[ambulante]" value="1">
                                            </div>
                                            <div>
                                                <label>Localit√†/Comune</label><br/>
                                                <input type="text" name="dati[localita]">
                                            </div>
                                            <div>
                                                <label>Indirizzo</label><br/>
                                                <input type="text" name="dati[indirizzo]">
                                            </div>
                                            <div>
                                                <label>Cap</label><br/>
                                                <input type="text" name="dati[cap]">
                                            </div>
                                            <div>
                                                <label>Latitudine</label><br/>
                                                <input type="text" name="dati[latitudine]">
                                            </div>
                                            <div>
                                                <label>Longitudine</label><br/>
                                                <input type="text" name="dati[longitudine]">
                                            </div>
                                            <button onclick="emit('setDatiNegozio')">SET DATI NEGOZIO</button>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                    <td>
                        <table border="1">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Action</th>
                                    <th>Function</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="log">
                            </tbody>
                        </table>
                    </td>
                </tr>
            </tbody>
        </table>
    </body>
</html>
